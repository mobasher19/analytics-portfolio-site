<!DOCTYPE html>
<html lang="en">
<head>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MX9K2M96');</script>
    
    <meta charset="UTF-8">
    <title>FitStore | Checkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital@0;1&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #F5F5F0; color: #2D2D2D; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .btn-primary { background-color: #2D2D2D; color: white; letter-spacing: 0.1em; text-transform: uppercase; font-size: 0.75rem; transition: all 0.3s; width: 100%; padding: 1.25rem; }
        .btn-primary:hover { background-color: #8B7E66; }
        input { border: 1px solid #e5e7eb; background-color: white; padding: 1rem; font-size: 0.875rem; width: 100%; }
        input:focus { border-color: #8B7E66; outline: none; }
    </style>
</head>
<body>
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MX9K2M96" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>

    <nav class="bg-white/90 backdrop-blur-md py-8 px-12 flex justify-between items-center border-b border-gray-100">
        <a href="index.html" class="text-xl tracking-[0.3em] font-light uppercase">FitStore</a>
        <div class="space-x-12 text-[10px] uppercase tracking-[0.2em] font-medium">
            <a href="index.html" class="hover:opacity-50 transition">Collection</a>
            <a href="cart.html" class="border-b border-black pb-1">Cart <span id="cart-count">(0)</span> ðŸ›’</a>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto py-16 px-12">
        <h1 class="text-4xl font-serif mb-12 text-center italic">Checkout Details</h1>

        <div class="bg-white p-8 rounded-sm shadow-sm mb-12 border border-gray-100">
            <h2 class="text-[10px] uppercase tracking-[0.2em] font-bold mb-6">Customer Information</h2>
            <div class="grid grid-cols-2 gap-4">
                <input type="text" id="fname" placeholder="First Name">
                <input type="text" id="lname" placeholder="Last Name">
            </div>
        </div>

        <div class="bg-white p-8 rounded-sm shadow-sm border border-gray-100 mb-8">
            <h2 class="text-[10px] uppercase tracking-[0.2em] font-bold mb-6">Your Items</h2>
            <div id="cart-list" class="space-y-4">
                </div>
        </div>

        <div class="flex justify-between items-end mb-8 px-4">
            <span class="text-[10px] uppercase tracking-[0.2em]">Total Amount</span>
            <span id="total-price" class="text-3xl font-serif italic">â‚¬0.00</span>
        </div>

        <button id="proceed-btn" class="btn-primary">Complete Purchase & Sync to CDP</button>
    </main>

    <script>
        // 1. DATABASE
        const products = [
            { id: 1, name: "Muscle Percussion Gun", price: 120.00 },
            { id: 2, name: "Foam Roller Deluxe", price: 35.00 },
            { id: 3, name: "Compression Sleeves", price: 25.00 },
            { id: 4, name: "Aromatherapy Mist", price: 18.00 },
            { id: 5, name: "Epsom Soak Salt", price: 15.00 },
            { id: 6, name: "Resistance Band Set", price: 29.99 },
            { id: 7, name: "Kettlebell 16kg", price: 55.00 },
            { id: 8, name: "Adjustable Dumbbells", price: 199.00 },
            { id: 9, name: "Pull Up Bar", price: 45.00 },
            { id: 10, name: "Weighted Vest", price: 80.00 },
            { id: 11, name: "Cork Yoga Mat", price: 85.00 },
            { id: 12, name: "Meditation Cushion", price: 40.00 },
            { id: 13, name: "Singing Bowl", price: 65.00 },
            { id: 14, name: "Incense Holder", price: 22.00 },
            { id: 15, name: "Yoga Block Pair", price: 20.00 }
        ];

        // 2. DATA LOADING
        function getBag() {
            const rawData = localStorage.getItem('fitstore_bag');
            console.log("Raw Data in LocalStorage:", rawData);
            return rawData ? JSON.parse(rawData).map(Number) : [];
        }

        let bagIds = getBag();
        let checkedIds = [...bagIds];

        // 3. RENDER FUNCTION
        function render() {
            const list = document.getElementById('cart-list');
            const countLabel = document.getElementById('cart-count');
            const totalLabel = document.getElementById('total-price');
            
            list.innerHTML = '';
            countLabel.innerText = `(${bagIds.length})`;

            const activeItems = products.filter(p => bagIds.includes(p.id));

            if (activeItems.length === 0) {
                list.innerHTML = '<p class="text-gray-400 italic py-4">Your bag is empty.</p>';
                totalLabel.innerText = "â‚¬0.00";
                return;
            }

            let total = 0;
            activeItems.forEach(p => {
                const isChecked = checkedIds.includes(p.id);
                if (isChecked) total += p.price;

                list.innerHTML += `
                    <div class="flex justify-between items-center pb-4 border-b border-gray-50">
                        <div class="flex items-center space-x-4">
                            <input type="checkbox" style="width:20px" ${isChecked ? 'checked' : ''} onchange="toggle(${p.id})">
                            <div>
                                <p class="text-sm font-medium ${!isChecked ? 'text-gray-400 line-through' : ''}">${p.name}</p>
                                <button onclick="remove(${p.id})" class="text-[10px] text-red-400 uppercase">Remove</button>
                            </div>
                        </div>
                        <p class="font-serif italic">â‚¬${p.price.toFixed(2)}</p>
                    </div>
                `;
            });
            totalLabel.innerText = `â‚¬${total.toFixed(2)}`;
        }

        // 4. ACTIONS
        window.toggle = (id) => {
            checkedIds = checkedIds.includes(id) ? checkedIds.filter(i => i !== id) : [...checkedIds, id];
            render();
        };

        window.remove = (id) => {
            bagIds = bagIds.filter(i => i !== id);
            checkedIds = checkedIds.filter(i => i !== id);
            localStorage.setItem('fitstore_bag', JSON.stringify(bagIds));
            render();
        };

        // 5. CHECKOUT & GA4
        document.getElementById('proceed-btn').addEventListener('click', async () => {
            const fName = document.getElementById('fname').value;
            const lName = document.getElementById('lname').value;
            const price = document.getElementById('total-price').innerText;

            if (!fName || checkedIds.length === 0) {
                alert("Please enter your name and select items.");
                return;
            }

            // GA4 Purchase Event
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'event': 'purchase',
                'ecommerce': {
                    'transaction_id': 'T_' + Date.now(),
                    'value': parseFloat(price.replace('â‚¬', '')),
                    'currency': 'EUR',
                    'items': checkedIds.map(id => {
                        const p = products.find(x => x.id === id);
                        return { 'item_id': p.id, 'item_name': p.name, 'price': p.price };
                    })
                }
            });

            // CDP Sync
            const scriptURL = 'https://script.google.com/macros/s/AKfycbxW82oFPuFVnp633vq0-kPtOeY7ju6WfUqfhOMDlUKwFfRTmGvUoXEyCpiXCmDIAOnx/exec';
            fetch(scriptURL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify({ firstName: fName, lastName: lName, productIds: checkedIds.join(','), price: price }) 
            }).then(() => {
                alert("Success!");
                localStorage.removeItem('fitstore_bag');
                window.location.href = "index.html";
            });
        });

        render();
    </script>
</body>
</html>
